data crab;
   input color spine width satellites weight site;
   color=color-1;
   weight=weight/1000;
datalines;
3  3  28.3  8  3050 1
4  3  22.5  0  1550 1
2  1  26.0  9  2300 1
4  3  24.8  0  2100 1
4  3  26.0  4  2600 1
3  3  23.8  0  2100 1
2  1  26.5  0  2350 1
4  2  24.7  0  1900 1
3  1  23.7  0  1950 1
4  3  25.6  0  2150 1
4  3  24.3  0  2150 1
3  3  25.8  0  2650 1
3  3  28.2  11 3050 2
5  2  21.0  0  1850 2
3  1  26.0  14 2300 2
2  1  27.1  8  2950 2
3  3  25.2  1  2000 2
3  3  29.0  1  3000 2
5  3  24.7  0  2200 2
3  3  27.4  5  2700 2
3  2  23.2  4  1950 3
2  2  25.0  3  2300 3
3  1  22.5  1  1600 3
4  3  26.7  2  2600 3
5  3  25.8  3  2000 3
5  3  26.2  0  1300 3
3  3  28.7  3  3150 3
3  1  26.8  5  2700 3
5  3  27.5  0  2600 3
3  3  24.9  0  2100 3
2  1  29.3  4  3200 3
2  3  25.8  0  2600 4
3  2  25.7  0  2000 4
3  1  25.7  8  2000 4
3  1  26.7  5  2700 4
5  3  23.7  0  1850 4
3  3  26.8  0  2650 4
3  3  27.5  6  3150 4
5  3  23.4  0  1900 4
3  3  27.9  6  2800 4
4  3  27.5  3  3100 4
2  1  26.1  5  2800 4
2  1  27.7  6  2500 4
3  1  30.0  5  3300 5
4  1  28.5  9  3250 5
4  3  28.9  4  2800 5
3  3  28.2  6  2600 5
3  3  25.0  4  2100 5
3  3  28.5  3  3000 5
3  1  30.3  3  3600 5
5  3  24.7  5  2100 5
3  3  27.7  5  2900 6
2  1  27.4  6  2700 6
3  3  22.9  4  1600 6
3  1  25.7  5  2000 6
3  3  28.3  15 3000 6
3  3  27.2  3  2700 6
4  3  26.2  3  2300 6
3  1  27.8  0  2750 6
5  3  25.5  0  2250 6
4  3  27.1  0  2550 6
4  3  24.5  5  2050 6
4  1  27.0  3  2450 6
3  3  26.0  5  2150 6
3  3  28.0  1  2800 7
3  3  30.0  8  3050 7
3  3  29.0  10 3200 7
3  3  26.2  0  2400 7
3  1  26.5  0  1300 7
3  3  26.2  3  2400 7
4  3  25.6  7  2800 7
4  3  23.0  1  1650 7
4  3  23.0  0  1800 7
3  3  25.4  6  2250 7
4  3  24.2  0  1900 7
3  2  22.9  0  1600 7
4  2  26.0  3  2200 7
3  3  25.4  4  2250 7
4  3  25.7  0  1200 8
3  3  25.1  5  2100 8
4  2  24.5  0  2250 8
5  3  27.5  0  2900 8
4  3  23.1  0  1650 8
4  1  25.9  4  2550 8
3  3  25.8  0  2300 8
5  3  27.0  3  2250 8
3  3  28.5  0  3050 8
5  1  25.5  0  2750 8
5  3  23.5  0  1900 8
3  2  24.0  0  1700 8
3  1  29.7  5  3850 8
3  1  26.8  0  2550 8
5  3  26.7  0  2450 9
3  1  28.7  0  3200 9
4  3  23.1  0  1550 9
3  1  29.0  1  2800 9
4  3  25.5  0  2250 9
4  3  26.5  1  1967 9
4  3  24.5  1  2200 9
4  3  28.5  1  3000 9
3  3  28.2  1  2867 9
3  3  24.5  1  1600 9
3  3  27.5  1  2550 9
3  2  24.7  4  2550 9
3  1  25.2  1  2000 9
4  3  27.3  1  2900 10
3  3  26.3  1  2400 10
3  3  29.0  1  3100 10
3  3  25.3  2  1900 10
3  3  26.5  4  2300 10
3  3  27.8  3  3250 10
3  3  27.0  6  2500 10
4  3  25.7  0  2100 10 
3  3  25.0  2  2100 10
3  3  31.9  2  3325 10
5  3  23.7  0  1800 10 
5  3  29.3  12 3225 10
4  3  22.0  0  1400 10
3  3  25.0  5  2400 10
4  3  27.0  6  2500 10
4  3  23.8  6  1800 10
2  1  30.2  2  3275 10
4  3  26.2  0  2225 11
3  3  24.2  2  1650 11
3  3  27.4  3  2900 11
3  2  25.4  0  2300 11
4  3  28.4  3  3200 11
5  3  22.5  4  1475 11
3  3  26.2  2  2025 11
3  1  24.9  6  2300 11
2  2  24.5  6  1950 11
3  3  25.1  0  1800 11
3  1  28.0  4  2900 11
5  3  25.8  10 2250 11
3  3  27.9  7  3050 11
3  3  24.9  0  2200 11
3  1  28.4  5  3100 11
4  3  27.2  5  2400 11
3  2  25.0  6  2250 11
3  3  27.5  6  2625 11
3  1  33.5  7  5200 12
3  3  30.5  3  3325 12
4  3  29.0  3  2925 12 
3  1  24.3  0  2000 12
3  3  25.8  0  2400 12
5  3  25.0  8  2100 12
3  1  31.7  4  3725 12
3  3  29.5  4  3025 12
4  3  24.0  10 1900 12
3  3  30.0  9  3000 12
3  3  27.6  4  2850 12
3  3  26.2  0  2300 12
3  1  23.1  0  2000 12
3  1  22.9  0  1600 12
5  3  24.5  0  1900 12
3  3  24.7  4  1950 12
3  3  28.3  0  3200 12
3  3  23.9  2  1850 12
4  3  23.8  0  1800 12
4  2  29.8  4  3500 12
3  3  26.5  4  2350 13 
3  3  26.0  3  2275 13
3  3  28.2  8  3050 13
5  3  25.7  0  2150 13
3  3  26.5  7  2750 13 
3  3  25.8  0  2200 13
4  3  24.1  0  1800 13
4  3  26.2  2  2175 13
4  3  26.1  3  2750 13
4  3  29.0  4  3275 13
2  1  28.0  0  2625 13
5  3  27.0  0  2625 13
3  2  24.5  0  2000 13
;
run;
goptions reset=all;
proc univariate data=crab;
   var satellites;
   histogram / normal kernel;
   probplot / normal(mu=est sigma=est) ;
run;

/*** Poisson regression without random effects **/
proc glimmix data=crab;
   class color spine site;
   model satellites = color spine weight width / dist=poi link=log solution ;
run;

/*** Poisson regression with random effects **/
proc glimmix data=crab;
   class color spine site;
   model satellites = color spine weight width / dist=poi link=log solution ;
   random int / subject=site;
run;

proc glimmix data=crab;
   class color spine site;
   model satellites = color spine weight width / dist=poi link=log solution ;
   random int / subject=site;
   output out=gmxout pred=pred
                     pred(ilink)=predmu
                     pearson=pearson;
run;

proc print data=gmxout (obs=10);
run;

proc means data=gmxout n mean var;
   var pearson;
run;

/** use maximum likelihood estimation method  */
proc glimmix data=crab method=quad;
   class color spine site;
   model satellites = color spine weight width / dist=poi link=log solution ;
   random int / subject=site;
run;
/*** MODEL THE OVER-DISPERSION ***/

/*** without random effects   ***/
proc glimmix data=crab;
   class color spine site;
   model satellites = color spine weight width / dist=poi link=log solution ;
   random _residual_;
run;

/*** with random effects  ***/
ods graphics on;
proc glimmix data=crab plots=studentpanel;
   class color spine site;
   model satellites = color spine weight width / dist=poi link=log solution ;
   random int / subject=site;
   random _residual_;
   output out=gmxout pearson=pearson;
run;
ods graphics off;

proc means data=gmxout n mean var;
   var pearson;
run;
/*** negative binomial  ***/
/*** without random effects  ***/
proc glimmix data=crab;
   class color spine site;
   model satellites = color spine weight width / dist=nb link=log solution;
run;

/*** with random effects  ***/
ods graphics on;
proc glimmix data=crab plot=studentpanel;
   class color spine site;
   model satellites = color spine weight width / dist=nb link=log 
                                                 solution;
   random int / subject=site;
   output out=gmxout pearson=pearson;
run;
ods graphics off;

proc means data=gmxout n mean var;
   var pearson;
run;

/** use maximum likelihood estimation method **/
proc glimmix data=crab method=quad;
   class color spine site;
   model satellites = color spine weight width / dist=nb link=log 
                                                 solution;
   random int / subject=site;
run;
